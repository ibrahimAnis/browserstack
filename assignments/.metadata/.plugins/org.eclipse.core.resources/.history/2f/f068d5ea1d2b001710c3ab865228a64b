class UnblockKeyWorker
  include Sidekiq::Worker
  
  def perform(id)
    puts "#{id}: UnblockKeyWorker: perform"
    if id != nil && $redis.exists(id.to_s)
      key = JSON.parse($redis.get(id.to_s))
      puts "#{id}: UnblockedKeyWorker: perform: #{key['blocked_timestamp']}"
      if key["blocked_timestamp"] != nil
        if Time.new(key["blocked_timestamp"]) <= Time.now
          puts "#{id}: UnblockKeyWorker: timeout"
          key["is_blocked"] = false
          key["blocked_timestamp"] = nil
          $redis.set(id.to_s, key.to_json)
          available = JSON.parse($redis.get("available"))
          available.push(id)
          puts"UnblockKeyWorker: perform: #{available}"
          $redis.set("available", available)
        end
      end
    else
      puts "#{id}: UnblockKeyWorker: key does not exist"
    end
  end
end