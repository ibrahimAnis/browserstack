'''
Key Server problem:
Write a server which can generate random api keys, assign them for usage and 
release them after sometime.

Following endpoints should be available on the server to interact with it.
E4. There should be an endpoint to delete a key. 
    Deleted keys should be purged.
E5. All keys are to be kept alive by clients calling this endpoint every 5 minutes.
    If a particular key has not received a keep alive in last five minutes then it should
    be deleted and never used again. 

Apart from these endpoints, following rules should be enforced:
R1. All blocked keys should get released automatically within 60 secs if E3 is not called.

No endpoint call should result in an iteration of whole set of keys i.e. 
no endpoint request should be O(n). They should either be O(lg n) or O(1).
'''
require 'sinatra'
require 'redis'
#require 'json'
require 'securerandom'

redis = Redis.new
keys = Hash.new()
generated = Array.new()
available = Array.new()

class Key
  attr_reader :id
  attr_reader :is_blocked
  attr_reader :is_dead

  def initialize(id)
    @id = id
    @keep_alive_timestamp = Time.now
    @is_blocked = false
    @blocked_timestamp = nil
    @is_dead = false
  end
  
  def keep_alive(timestamp)
    @keep_alive_timestamp = timestamp
  end
  
  def block(timestamp)
    @is_blocked = true
    @blocked_timestamp = timestamp
  end
  
  def release
    @is_blocked = false
    @blocked_timestamp = nil
  end
  
  def dead
    @is_dead = true
  end

#  E1. There should be one endpoint to generate keys.
get '/e1' do
  id = SecureRandom.hex(64)
  key = Key.new(id)
  keys[id] = key
  generated.push(keys[id])
  available.push(keys[id])
  [200]
end

#E2. There should be an endpoint to get an available key. 
#    On hitting this endpoint server should serve a random key which is not already being used.
#    This key should be blocked and should not be served again by E2, till it is in this state
#    If no eligible key is available then it should serve 404.
get '/e2' do
  key = available.shift
  if key != nil
    if !key.is_dead
      key.block(Time.now)
      [200, key.id]
    end
  else
    [404]
end

#E3. There should be an endpoint to unblock a key. 
#    Unblocked keys can be served via E2 again.
get '/e3/:id' do
  id = params[id]
  keys[id].release
end

delete '/e4' do
  
end

put '/e5' do
  
end